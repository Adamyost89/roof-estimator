/*
Folder layout

  index.html            Client UI with three steps
  api/solar.js          Serverless proxy for Google Solar API
  api/vision.js         Serverless OpenAI Vision fallback for polygon and pitch

How to deploy

  1. Create a project on Vercel or Netlify. Vercel example below.
  2. Add environment variables in your dashboard
       GOOGLE_MAPS_KEY      your browser Maps JavaScript key
       GOOGLE_SOLAR_KEY     a restricted server key with Solar API enabled
       OPENAI_API_KEY       your OpenAI key
  3. Drop these three files into the repo. For Vercel, put api files under /api
  4. Deploy. Visit the site. Type an address. It will try Solar first, then Vision.

Notes

  • Keys are never exposed from the serverless functions. The browser only calls /api endpoints.
  • If Solar provides footprint or roof stats, we use it. Otherwise we ask the Vision endpoint to draw the polygon from a Static Maps tile.
  • Area is computed with Google Maps geometry in the browser. Pitch is either from Solar or an estimate by Vision.
*/

<!-- ========================= index.html ========================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Instant Roof Estimator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
    :root{ --brand:#187087; --brandDark:#0d3d47; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:'Poppins', Arial, sans-serif; background:#f5f7f9; color:#222; }
    #app{ max-width: 820px; margin: 36px auto; padding: 0 16px; }
    .card{ background:#fff; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.08); padding:18px; }
    h2{ margin:.2rem 0 1rem; color:var(--brand); font-size:22px; }
    .row{ display:flex; gap:12px; align-items:center; }
    .btn{ background: linear-gradient(90deg, var(--brand) 0%, var(--brandDark) 100%); color:#fff; border:none; border-radius:10px; padding:10px 16px; font-weight:600; cursor:pointer; }
    .text{ width:100%; padding:12px; border:2px solid #d9e2e6; border-radius:10px; font-size:16px; }
    #map{ height:380px; border-radius:10px; margin-top:10px; }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:#eef6f8; color:#175364; font-weight:600; font-size:13px; }
    .foot{ margin-top:10px; color:#46646f; font-size:14px; }
    .grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:14px; margin-top:12px; }
    .tile{ border:2px solid transparent; border-radius:12px; background:#f9fbfc; cursor:pointer; overflow:hidden; }
    .tile.selected{ border-color:var(--brand); background:#eef6f8; }
    .tile img{ width:100%; aspect-ratio:4/3; object-fit:cover; display:block; }
    .tile .body{ padding:10px; text-align:center; }
  </style>
</head>
<body>
  <div id="app">
    <div class="card">
      <h2>Enter your address</h2>
      <div class="row">
        <input id="addr" class="text" placeholder="123 Main St, Dayton OH" />
        <button id="go" class="btn">Next</button>
      </div>
      <div id="msg" class="foot"></div>
    </div>

    <div class="card" style="margin-top:14px; display:none" id="stepMap">
      <h2>Confirm your roof</h2>
      <div class="row" style="gap:8px">
        <span id="est" class="pill">Size — squares</span>
        <span id="pit" class="pill">Pitch low</span>
        <button id="accept" class="btn" style="margin-left:auto">Next</button>
      </div>
      <div id="map"></div>
      <div class="foot">You can drag vertices to adjust if needed</div>
    </div>

    <div class="card" style="margin-top:14px; display:none" id="stepMaterials">
      <h2>Select your material</h2>
      <div id="matGrid" class="grid"></div>
      <div class="foot">Pricing is shown as a range with a finance option per month</div>
    </div>
  </div>

  <script>
    const BOOKING_URL = 'https://proline.app/form/kk46dbled';
    const MATERIALS_URL = 'https://script.google.com/macros/s/AKfycbzkVZSW5xTCUGKZoUPYdnFXNfmSBFJVh6ZfFxEtAZF_CNizs5s30Sf_uF5PLCCvFdv5Mg/exec?action=materials';

    let gmap, geocoder, polygon, marker;
    let areaFt2Base = 0, pitchText = 'low';

    document.getElementById('go').addEventListener('click', async () => {
      const q = document.getElementById('addr').value.trim();
      if (!q) { document.getElementById('msg').textContent = 'Please enter an address'; return; }
      const loc = await geocode(q);
      if (!loc) { document.getElementById('msg').textContent = 'Address not found'; return; }
      document.getElementById('msg').textContent = '';
      await showMap(loc.lat, loc.lng, q);
      await trySolarThenVision(loc.lat, loc.lng);
    });

    document.getElementById('accept').addEventListener('click', async () => {
      document.getElementById('stepMaterials').style.display = 'block';
      const mats = await loadMaterials();
      renderMaterials(mats);
      window.scrollTo({ top: document.getElementById('stepMaterials').offsetTop, behavior: 'smooth' });
    });

    async function geocode(address){
      return new Promise((resolve) => {
        if (!geocoder) geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address }, (results, status) => {
          if (status === 'OK' && results[0]){
            const ll = results[0].geometry.location;
            resolve({ lat: ll.lat(), lng: ll.lng(), place_id: results[0].place_id });
          } else resolve(null);
        });
      });
    }

    async function showMap(lat, lng, label){
      const mapDiv = document.getElementById('stepMap');
      mapDiv.style.display = 'block';
      if (!gmap){
        gmap = new google.maps.Map(document.getElementById('map'), {
          center: { lat, lng }, zoom: 19, mapTypeId: 'satellite', clickableIcons: false, tilt: 0, heading: 0
        });
      } else {
        gmap.setCenter({ lat, lng });
        gmap.setZoom(19);
      }
      if (marker) marker.setMap(null);
      marker = new google.maps.Marker({ map: gmap, position: { lat, lng }, title: label || 'Property' });
    }

    function drawPolygonLatLng(latlngs){
      if (polygon) polygon.setMap(null);
      polygon = new google.maps.Polygon({
        paths: latlngs, map: gmap, editable: true, draggable: true,
        strokeColor:'#187087', strokeOpacity:0.95, strokeWeight:2, fillColor:'#187087', fillOpacity:0.35
      });
      fitToPolygon();
      google.maps.event.addListener(polygon.getPath(), 'set_at', () => updateArea());
      google.maps.event.addListener(polygon.getPath(), 'insert_at', () => updateArea());
      google.maps.event.addListener(polygon, 'dragend', () => updateArea());
      updateArea();
    }

    function fitToPolygon(){
      const b = new google.maps.LatLngBounds();
      polygon.getPath().forEach(p => b.extend(p));
      gmap.fitBounds(b, { top:40, bottom:40, left:40, right:40 });
      if (gmap.getZoom() > 20) gmap.setZoom(20);
      gmap.setTilt(0); gmap.setHeading(0);
    }

    function updateArea(){
      const pts = polygon.getPath().getArray();
      const areaM2 = google.maps.geometry.spherical.computeArea(pts);
      areaFt2Base = areaM2 * 10.7639;
      const squares = areaFt2Base * 1.12 / 100; // includes a gentle default pitch factor
      document.getElementById('est').textContent = `Size ${squares.toFixed(1)} squares`;
      document.getElementById('pit').textContent = `Pitch ${pitchText}`;
    }

    async function trySolarThenVision(lat, lng){
      // 1 Solar
      try{
        const res = await fetch(`/api/solar?lat=${lat}&lng=${lng}`);
        if (res.ok){
          const data = await res.json();
          if (data && data.polygon && Array.isArray(data.polygon) && data.polygon.length >= 3){
            const ring = data.polygon.map(([y,x]) => new google.maps.LatLng(y, x)); // GeoJSON order
            drawPolygonLatLng(ring);
            if (data.pitchCategory) pitchText = data.pitchCategory;
            return;
          }
        }
      }catch{}

      // 2 Vision fallback
      const url = new URL('https://maps.googleapis.com/maps/api/staticmap');
      url.searchParams.set('key', GOOGLE_MAPS_KEY_FROM_HTML);
      url.searchParams.set('center', `${lat},${lng}`);
      url.searchParams.set('zoom', '21');
      url.searchParams.set('size', '640x640');
      url.searchParams.set('maptype', 'satellite');
      url.searchParams.set('scale', '1');
      const staticUrl = url.toString();

      const vres = await fetch('/api/vision', {
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ lat, lng, zoom:21, size:640, imageUrl: staticUrl })
      });
      if (!vres.ok){ drawFallbackRect(lat, lng); return; }
      const vjson = await vres.json();
      if (vjson && vjson.type === 'Feature' && vjson.geometry?.type === 'Polygon'){
        const coords = vjson.geometry.coordinates[0];
        const ring = coords.map(([x,y]) => new google.maps.LatLng(y, x));
        drawPolygonLatLng(ring);
        if (vjson.properties?.pitchCategory) pitchText = vjson.properties.pitchCategory;
      } else {
        drawFallbackRect(lat, lng);
      }
    }

    function drawFallbackRect(lat, lng){
      const d = 0.00012;
      const ring = [
        { lat:lat-d, lng:lng-d }, { lat:lat-d, lng:lng+d }, { lat:lat+d, lng:lng+d }, { lat:lat+d, lng:lng-d }
      ].map(o => new google.maps.LatLng(o.lat, o.lng));
      drawPolygonLatLng(ring);
    }

    async function loadMaterials(){
      try{
        const r = await fetch(MATERIALS_URL, { cache:'no-store' });
        const rows = await r.json();
        if (Array.isArray(rows) && rows.length) return rows;
      }catch{}
      return [
        { id:'asphalt', name:'Asphalt', img:'https://images.unsplash.com/photo-1613977257597-38b7f5f2bd1a?q=80&w=1200&auto=format&fit=crop', pricePerSq:550, apr:9.99, term:120 },
        { id:'metal', name:'Standing Seam', img:'https://images.unsplash.com/photo-1601914971419-6b2aaf9ce1ef?q=80&w=1200&auto=format&fit=crop', pricePerSq:1200, apr:8.99, term:180 }
      ];
    }

    function renderMaterials(items){
      const box = document.getElementById('matGrid');
      box.innerHTML = '';
      const squares = (areaFt2Base * 1.12) / 100;
      for (const m of items){
        const low = Math.round(squares * Math.round((m.pricePerSqLow || m.pricePerSq*0.9) || 0));
        const high= Math.round(squares * Math.round((m.pricePerSqHigh || m.pricePerSq*1.1) || 0));
        const apr = Number(m.apr || 0) / 1200;
        const n = Number(m.term || 120);
        const pmt = apr>0 ? Math.round(high * (apr*Math.pow(1+apr,n))/(Math.pow(1+apr,n)-1)) : Math.round(high/n);
        const el = document.createElement('div'); el.className = 'tile';
        el.innerHTML = `
          <img src="${m.img}" alt="${m.name}" loading="lazy" onerror="this.src='https://images.unsplash.com/photo-1613977257597-38b7f5f2bd1a?q=80&w=1200&auto=format&fit=crop'"/>
          <div class="body">
            <div style="font-weight:700; color:#176174;">${m.name}</div>
            <div>Cash $${low.toLocaleString()} to $${high.toLocaleString()}</div>
            <div>Finance $${pmt.toLocaleString()}/mo</div>
            <button class="btn" style="margin-top:8px" onclick="window.open('${BOOKING_URL}','_blank')">Schedule inspection</button>
          </div>`;
        el.addEventListener('click', () => {
          document.querySelectorAll('.tile').forEach(t => t.classList.remove('selected'));
          el.classList.add('selected');
        });
        box.appendChild(el);
      }
    }

    // Injected at build time or from server. Set here for dev simplicity.
    const GOOGLE_MAPS_KEY_FROM_HTML = '${process.env.GOOGLE_MAPS_KEY || 'AIzaSyDPFfmUD6XSU67KIUiRL0gdgO7B-vauuQw'}';
  </script>
  <script async src="https://maps.googleapis.com/maps/api/js?key=${process.env.GOOGLE_MAPS_KEY || 'AIzaSyDPFfmUD6XSU67KIUiRL0gdgO7B-vauuQw'}&libraries=geometry"></script>
</body>
</html>
